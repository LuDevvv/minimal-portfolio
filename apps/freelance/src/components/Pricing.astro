---
import { getLangFromUrl, useTranslations } from "../i18n/ui";
import { CheckCircle2, Search, Zap, Clock, FileText } from "lucide-astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const processPrice = (key: string) => {
    const raw = t(key as any)
        .replace("$", "")
        .trim();
    const match = raw.match(/^([^\d]*)([\d.,]+.*)$/);
    if (match) {
        return { prefix: match[1].trim(), amount: match[2].trim() };
    }
    return { prefix: "", amount: raw };
};

const plans = [
    {
        title: t("pricing.pkg1.title"),
        ...processPrice("pricing.pkg1.price"),
        currency: "$",
        sub: "",
        desc: t("pricing.pkg1.desc"),
        features: [
            t("pricing.pkg1.feat1"),
            t("pricing.pkg1.feat2"),
            t("pricing.pkg1.feat3"),
            t("pricing.pkg1.feat4"),
        ],
        highlighted: false,
    },
    {
        title: t("pricing.pkg2.title"),
        ...processPrice("pricing.pkg2.price"),
        currency: "$",
        sub: "",
        desc: t("pricing.pkg2.desc"),
        features: [
            t("pricing.pkg2.feat1"),
            t("pricing.pkg2.feat2"),
            t("pricing.pkg2.feat3"),
            t("pricing.pkg2.feat4"),
            "Acceso Prioritario",
        ],
        highlighted: true,
    },
    {
        title: t("pricing.pkg3.title"),
        ...processPrice("pricing.pkg3.price"),
        currency: "$",
        sub: "", // User Requested removal of /month
        desc: t("pricing.pkg3.desc"),
        features: [
            t("pricing.pkg3.feat1"),
            t("pricing.pkg3.feat2"),
            t("pricing.pkg3.feat3"),
            t("pricing.pkg3.feat4"),
        ],
        highlighted: false,
    },
];

const audit = {
    title: t("pricing.audit.title"),
    sub: t("pricing.audit.sub"),
    desc: t("pricing.audit.desc"),
    price: t("pricing.audit.price"),
    delivery: t("pricing.audit.delivery"),
    cta: t("pricing.audit.cta"),
    features: [
        { icon: Zap, text: t("pricing.audit.feat1") },
        { icon: FileText, text: t("pricing.audit.feat2") },
        { icon: Search, text: t("pricing.audit.feat3") },
        { icon: CheckCircle2, text: t("pricing.audit.feat4") },
    ],
};
---

<section id="pricing" class="py-16 md:py-24 px-6 bg-surface reveal">
    <div class="container mx-auto">
        <!-- Header -->
        <div class="mb-12 md:mb-16 max-w-2xl mx-auto text-center">
            <span
                class="inline-block px-3 py-1 text-xs font-bold tracking-widest text-primary uppercase bg-primary/10 rounded-full mb-4"
            >
                {t("pricing.badge")}
            </span>
            <h2 class="text-4xl md:text-5xl font-extrabold mb-6 text-gradient">
                {t("pricing.title")}
            </h2>
            <p class="text-lg text-fg-muted leading-relaxed">
                {t("pricing.description")}
            </p>
        </div>

        <div
            class="grid lg:grid-cols-3 gap-8 items-start max-w-6xl mx-auto mb-16"
        >
            {
                plans.map((plan) => (
                    <div
                        class={`p-8 md:p-10 rounded-[2.5rem] flex flex-col relative transition-transform duration-500 hover:scale-[1.02] ${
                            plan.highlighted
                                ? "glass border-primary/50 ring-1 ring-primary/20 scale-105 z-10 shadow-2xl shadow-primary/10"
                                : "glass border-glass-border"
                        }`}
                    >
                        {plan.highlighted && (
                            <span class="absolute -top-4 left-1/2 -translate-x-1/2 px-4 py-1.5 bg-primary text-white text-[10px] font-black uppercase rounded-full shadow-lg shadow-primary/30">
                                {t("pricing.popular")}
                            </span>
                        )}
                        <h3 class="text-xl font-bold mb-4 text-fg">
                            {plan.title}
                        </h3>

                        <div class="flex flex-col mb-6">
                            {plan.prefix && (
                                <span class="text-xs font-bold text-fg-muted uppercase tracking-wider mb-1">
                                    {plan.prefix}
                                </span>
                            )}
                            <div class="flex items-baseline gap-1">
                                <span class="text-3xl font-bold text-fg">
                                    {plan.currency}
                                </span>
                                <span class="text-5xl font-black text-fg">
                                    {plan.amount}
                                </span>
                                {plan.sub && (
                                    <span class="text-fg-muted text-sm font-medium">
                                        {plan.sub}
                                    </span>
                                )}
                            </div>
                        </div>

                        <p class="text-fg-muted text-sm mb-8 min-h-[40px]">
                            {plan.desc}
                        </p>
                        <div class="space-y-4 mb-10 grow relative z-10">
                            {plan.features.map((f) => (
                                <div class="flex items-center gap-3 text-sm text-fg-muted/80">
                                    <CheckCircle2 class="text-primary w-[18px] h-[18px] shrink-0" />
                                    <span>{f}</span>
                                </div>
                            ))}
                        </div>
                        <a
                            href="#contact"
                            class={`w-full py-4 rounded-2xl font-bold transition-all active:scale-95 text-center block ${
                                plan.highlighted
                                    ? "bg-primary text-white hover:bg-secondary"
                                    : "bg-surface text-fg hover:bg-surface-lighter ring-1 ring-glass-border"
                            }`}
                        >
                            {t("pricing.cta")}
                        </a>
                    </div>
                ))
            }
        </div>

        <!-- Technical Audit (Low Ticket) -->
        <div class="max-w-6xl mx-auto">
            <div
                class="glass p-8 md:p-12 rounded-[2.5rem] border border-dashed border-primary/30 relative overflow-hidden group hover:border-primary/50 transition-colors"
            >
                <div class="absolute inset-0 bg-surface-lighter/50 -z-10"></div>

                <div
                    class="flex flex-col lg:flex-row gap-8 lg:gap-16 items-start lg:items-center"
                >
                    <div class="flex-1">
                        <div class="inline-flex items-center gap-2 mb-4">
                            <span
                                class="bg-primary/10 text-primary px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider"
                                >Low Ticket Entry</span
                            >
                        </div>
                        <h3 class="text-3xl font-bold text-fg mb-2">
                            {audit.title}
                        </h3>
                        <p class="text-lg font-medium text-primary mb-4">
                            {audit.sub}
                        </p>
                        <p class="text-fg-muted leading-relaxed mb-8 max-w-2xl">
                            {audit.desc}
                        </p>

                        <div class="grid sm:grid-cols-2 gap-4 mb-8">
                            {
                                audit.features.map((f) => (
                                    <div class="flex items-center gap-3 text-sm font-medium text-fg-muted">
                                        <f.icon class="w-5 h-5 text-primary shrink-0" />
                                        <span>{f.text}</span>
                                    </div>
                                ))
                            }
                        </div>

                        <div
                            class="flex items-center gap-3 text-xs font-bold uppercase tracking-wider text-fg-muted/70 bg-surface px-4 py-2 rounded-lg inline-flex"
                        >
                            <Clock class="w-4 h-4" />
                            {audit.delivery}
                        </div>
                    </div>

                    <div
                        class="w-full lg:w-auto flex flex-col items-center lg:items-end gap-6 shrink-0 p-6 bg-surface rounded-2xl border border-glass-border text-center lg:text-right min-w-[280px]"
                    >
                        <div>
                            <span
                                class="text-sm font-bold text-fg-muted block mb-1"
                                >One-time payment</span
                            >
                            <span
                                class="text-4xl font-black text-fg tracking-tight"
                                >{audit.price}</span
                            >
                        </div>
                        <a
                            href="#contact"
                            class="w-full py-4 px-8 bg-fg text-canvas rounded-xl font-bold hover:shadow-xl hover:-translate-y-1 transition-all active:scale-95 text-center"
                        >
                            {audit.cta}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
