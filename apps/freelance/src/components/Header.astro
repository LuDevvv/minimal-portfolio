---
import { getLangFromUrl, useTranslations } from "../i18n/ui";
import {
    Languages,
    Menu,
    X,
    FolderKanban,
    Layers,
    Workflow,
    CreditCard,
    Mail,
    ChevronRight,
    Sun,
    Moon,
} from "lucide-astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const navItems = [
    { label: t("nav.services"), href: "#services", icon: Layers },
    { label: t("nav.projects"), href: "#projects", icon: FolderKanban },
    { label: t("nav.process"), href: "#process", icon: Workflow },
    { label: t("nav.pricing"), href: "#pricing", icon: CreditCard },
];
---

<header
    class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 border-b border-transparent"
    id="main-header"
>
    <div
        class="container mx-auto px-6 h-20 md:h-24 flex items-center justify-between"
    >
        <!-- Logo (Left) -->
        <div class="flex-1 flex justify-start">
            <a
                href="/"
                class="text-2xl font-black tracking-tighter flex items-center gap-1 group z-50 relative hover:opacity-80 transition-opacity"
            >
                <span class="text-fg"
                    >Louis<span
                        class="text-primary text-3xl leading-0 relative top-0.5"
                        >.</span
                    ></span
                >
            </a>
        </div>

        <!-- Desktop Nav (Center) -->
        <nav class="hidden md:flex items-center justify-center gap-8 flex-1">
            {
                navItems.map((item) => (
                    <a
                        href={item.href}
                        class="text-sm font-bold text-fg-muted hover:text-primary transition-colors tracking-wide"
                    >
                        {item.label}
                    </a>
                ))
            }
            <a
                href="#contact"
                class="px-6 py-2.5 bg-fg text-canvas hover:bg-primary hover:text-white rounded-full text-sm font-bold transition-all shadow-lg hover:shadow-primary/25 hover:-translate-y-0.5"
            >
                {t("nav.contact")}
            </a>
        </nav>

        <!-- Right Controls -->
        <div class="flex-1 flex justify-end gap-4 items-center z-50 relative">
            <!-- Desktop Theme/Lang Toggles (Hidden on Mobile) -->
            <div class="hidden md:flex items-center gap-3">
                <button
                    id="theme-toggle-desktop"
                    class="w-10 h-10 rounded-full bg-surface hover:bg-surface-lighter border border-glass-border flex items-center justify-center text-fg-muted hover:text-primary transition-colors"
                    aria-label="Toggle Theme"
                >
                    <Sun class="w-5 h-5 hidden dark:block" />
                    <Moon class="w-5 h-5 block dark:hidden" />
                </button>

                <a
                    href={lang === "es" ? "/en" : "/"}
                    class="h-10 px-4 rounded-full bg-surface hover:bg-surface-lighter border border-glass-border flex items-center justify-center gap-2 text-xs font-bold text-fg hover:text-primary transition-colors"
                >
                    <Languages class="w-4 h-4" />
                    {lang === "es" ? "ES" : "EN"}
                </a>
            </div>

            <!-- Mobile Menu Button -->
            <button
                id="menu-toggle"
                class="md:hidden w-12 h-12 rounded-2xl bg-surface border border-glass-border flex items-center justify-center text-fg hover:bg-surface-lighter transition-colors"
                aria-label="Menu"
            >
                <Menu
                    class="w-6 h-6 transition-transform duration-300"
                    id="menu-icon"
                />
                <X
                    class="w-6 h-6 absolute opacity-0 rotate-90 scale-0 transition-all duration-300"
                    id="close-icon"
                />
            </button>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div
        id="mobile-menu-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-500 md:hidden"
    >
    </div>

    <!-- Mobile Menu Card -->
    <div
        id="mobile-menu"
        class="absolute top-0 left-0 w-full bg-canvas z-40 transform -translate-y-full transition-transform duration-500 ease-out shadow-2xl rounded-b-[2.5rem] border-b border-border/50 overflow-hidden md:hidden"
    >
        <div class="pt-28 pb-10 px-6 flex flex-col items-center gap-4">
            {
                navItems.map((item) => (
                    <a
                        href={item.href}
                        class="mobile-link text-xl font-bold text-fg-muted hover:text-primary flex items-center gap-4 w-full p-4 rounded-2xl hover:bg-surface transition-all group border border-transparent hover:border-border/50"
                    >
                        <div class="w-10 h-10 rounded-xl bg-surface group-hover:bg-primary/10 flex items-center justify-center text-fg group-hover:text-primary transition-colors">
                            <item.icon class="w-5 h-5" />
                        </div>
                        {item.label}
                        <ChevronRight class="w-5 h-5 ml-auto opacity-0 group-hover:opacity-100 -translate-x-2 group-hover:translate-x-0 transition-all" />
                    </a>
                ))
            }
            <a
                href="#contact"
                class="mobile-link text-xl font-bold text-white bg-primary flex items-center gap-4 w-full p-4 rounded-2xl shadow-lg shadow-primary/20 transition-all active:scale-95 mt-2"
            >
                <div
                    class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center text-white"
                >
                    <Mail class="w-5 h-5" />
                </div>
                {t("nav.contact")}
                <ChevronRight class="w-5 h-5 ml-auto text-white" />
            </a>

            <!-- Mobile Controls (Theme & Lang) -->
            <div
                class="flex items-center justify-between w-full pt-6 mt-2 border-t border-border/30 mobile-link"
                style="transition-delay: 400ms"
            >
                <div
                    class="text-xs font-bold text-fg-muted uppercase tracking-widest pl-2"
                >
                    Preferences
                </div>

                <div class="flex gap-3">
                    <!-- Mobile Theme Toggle -->
                    <button
                        id="theme-toggle-mobile"
                        class="w-12 h-12 rounded-xl bg-surface border border-border flex items-center justify-center text-fg hover:text-primary transition-colors"
                        aria-label="Toggle Theme Mobile"
                    >
                        <Sun class="w-6 h-6 hidden dark:block" />
                        <Moon class="w-6 h-6 block dark:hidden" />
                    </button>

                    <!-- Mobile Lang Switcher -->
                    <a
                        href={lang === "es" ? "/en" : "/"}
                        class="h-12 px-5 rounded-xl bg-surface border border-border flex items-center justify-center gap-2 text-sm font-bold text-fg hover:text-primary transition-colors"
                    >
                        <Languages class="w-5 h-5" />
                        {lang === "es" ? "ES" : "EN"}
                    </a>
                </div>
            </div>

            <!-- Handle Indicator -->
            <div class="w-12 h-1.5 bg-border/50 rounded-full mt-2"></div>
        </div>
    </div>
</header>

<style>
    .mobile-link {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease-out;
    }

    #mobile-menu.open .mobile-link {
        opacity: 1;
        transform: translateY(0);
    }
</style>

<script>
    const header = document.getElementById("main-header");
    const menuToggle = document.getElementById("menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");
    const backdrop = document.getElementById("mobile-menu-backdrop");
    const menuIcon = document.getElementById("menu-icon");
    const closeIcon = document.getElementById("close-icon");
    const links = document.querySelectorAll(".mobile-link");

    // Scroll Effect
    window.addEventListener("scroll", () => {
        if (window.scrollY > 50) {
            header?.classList.add(
                "bg-canvas/80",
                "backdrop-blur-md",
                "border-glass-border",
                "shadow-sm",
            );
            header?.classList.remove("border-transparent");
        } else {
            header?.classList.remove(
                "bg-canvas/80",
                "backdrop-blur-md",
                "border-glass-border",
                "shadow-sm",
            );
            header?.classList.add("border-transparent");
        }
    });

    // Menu Toggle
    function toggleMenu() {
        const isOpen = mobileMenu?.classList.contains("!translate-y-0");

        if (isOpen) {
            // Close
            mobileMenu?.classList.remove("!translate-y-0");
            backdrop?.classList.remove("opacity-100", "pointer-events-auto");
            menuIcon?.classList.remove("rotate-90", "opacity-0", "scale-0");
            closeIcon?.classList.add("rotate-90", "opacity-0", "scale-0");
            document.body.style.overflow = "";

            mobileMenu?.classList.remove("open");
        } else {
            // Open
            mobileMenu?.classList.add("!translate-y-0");
            backdrop?.classList.add("opacity-100", "pointer-events-auto");
            menuIcon?.classList.add("rotate-90", "opacity-0", "scale-0");
            closeIcon?.classList.remove("rotate-90", "opacity-0", "scale-0");
            document.body.style.overflow = "hidden";

            setTimeout(() => {
                mobileMenu?.classList.add("open");
                links.forEach((link, idx) => {
                    (link as HTMLElement).style.transitionDelay =
                        `${idx * 75}ms`;
                });
            }, 50);
        }
    }

    menuToggle?.addEventListener("click", toggleMenu);
    backdrop?.addEventListener("click", toggleMenu);

    links.forEach((link) => {
        link.addEventListener("click", toggleMenu);
    });

    // Theme Toggle Logic (Shared function for desktop and mobile buttons)
    function toggleTheme() {
        const element = document.documentElement;
        element.classList.toggle("dark");

        const isDark = element.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    const themeToggleDesktop = document.getElementById("theme-toggle-desktop");
    const themeToggleMobile = document.getElementById("theme-toggle-mobile");
    const themeInitial = (() => {
        if (
            typeof localStorage !== "undefined" &&
            localStorage.getItem("theme")
        ) {
            return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            return "dark";
        }
        return "light";
    })();

    if (themeInitial === "light") {
        document.documentElement.classList.remove("dark");
    } else {
        document.documentElement.classList.add("dark");
    }
    window.localStorage.setItem("theme", themeInitial || "dark");

    themeToggleDesktop?.addEventListener("click", toggleTheme);
    themeToggleMobile?.addEventListener("click", toggleTheme);
</script>
